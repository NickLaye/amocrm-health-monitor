name: Dependency Health

on:
  schedule:
    - cron: '30 6 * * 1-5' # –∫–∞–∂–¥—ã–π –±—É–¥–Ω–∏–π –¥–µ–Ω—å –≤ 09:30 –ø–æ –ú–°–ö
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  scan:
    runs-on: ubuntu-latest
    env:
      SECURITY_ALERT: '0'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install backend dependencies
        run: npm ci --ignore-scripts

      - name: Install frontend dependencies
        run: cd client && npm ci --ignore-scripts

      - name: Collect dependency data
        run: |
          mkdir -p reports
          npm outdated --json > reports/root-outdated.json || true
          npm audit --omit=dev --json > reports/root-audit.json || true
          cd client
          npm outdated --json > ../reports/client-outdated.json || true
          npm audit --omit=dev --json > ../reports/client-audit.json || true

      - name: Build dependency report
        run: |
          node <<'EOF'
          const fs = require('fs');
          const path = require('path');
          const reportsDir = path.join(process.cwd(), 'reports');

          const readJson = (file) => {
            const target = path.join(reportsDir, file);
            if (!fs.existsSync(target)) return {};
            const raw = fs.readFileSync(target, 'utf8').trim();
            if (!raw) return {};
            try {
              return JSON.parse(raw);
            } catch {
              return {};
            }
          };

          const formatOutdated = (label, data) => {
            const entries = Object.entries(data || {});
            if (!entries.length) {
              return `### ${label}\n–ù–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –ø–∞–∫–µ—Ç–æ–≤ üéâ\n`;
            }

            const lines = entries.map(([pkg, info]) => {
              const type = info.type || 'dependency';
              return `- \`${pkg}\` (${type}) ‚Äî ${info.current} ‚Üí ${info.latest} (wanted ${info.wanted})`;
            });

            return `### ${label}\n${lines.join('\n')}\n`;
          };

          const flattenAudits = (source) => {
            if (!source || !source.vulnerabilities) return [];
            return Object.entries(source.vulnerabilities).map(([name, info]) => {
              const severity = (info.severity || '').toLowerCase();
              const via = (info.via || []).map((item) => {
                if (typeof item === 'string') return item;
                if (item && typeof item === 'object') {
                  return item.title || item.source || '';
                }
                return '';
              }).filter(Boolean);

              const fixAvailable = info.fixAvailable;
              let fix = 'manual';
              if (fixAvailable && typeof fixAvailable === 'object') {
                const fixName = fixAvailable.name || name;
                const fixVersion = fixAvailable.version || '';
                fix = fixVersion ? `${fixName}@${fixVersion}` : fixName;
              } else if (typeof fixAvailable === 'string') {
                fix = fixAvailable;
              }

              return {
                name,
                severity,
                via,
                scope: info.isDirect ? 'direct' : 'transitive',
                fix,
              };
            });
          };

          const backendOutdated = readJson('root-outdated.json');
          const frontendOutdated = readJson('client-outdated.json');
          const backendAudit = readJson('root-audit.json');
          const frontendAudit = readJson('client-audit.json');

          const auditEntries = [
            ...flattenAudits(backendAudit).map((item) => ({ ...item, project: 'backend' })),
            ...flattenAudits(frontendAudit).map((item) => ({ ...item, project: 'frontend' })),
          ].filter((item) => item.severity === 'high' || item.severity === 'critical');

          const reportParts = [
            '# Dependency Health Report',
            '',
            '## npm outdated',
            formatOutdated('Backend (root)', backendOutdated),
            formatOutdated('Frontend (client)', frontendOutdated),
            '## npm audit (High/Critical findings)',
          ];

          if (!auditEntries.length) {
            reportParts.push('–ö—Ä–∏—Ç–∏—á–Ω—ã—Ö –∏–ª–∏ –≤—ã—Å–æ–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ ‚úÖ');
          } else {
            reportParts.push('| –ü—Ä–æ–µ–∫—Ç | –ü–∞–∫–µ—Ç | Severity | –¢–∏–ø | –í–æ–∑–º–æ–∂–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ |');
            reportParts.push('|--------|-------|----------|-----|-----------------------|');
            auditEntries.forEach((item) => {
              const via = item.via.slice(0, 2).join(', ') || 'n/a';
              reportParts.push(`| ${item.project} | \`${item.name}\` | ${item.severity} | ${item.scope} | ${item.fix} (${via}) |`);
            });
          }

          const reportPath = path.join(reportsDir, 'dependency-health.md');
          fs.writeFileSync(reportPath, reportParts.join('\n') + '\n', 'utf8');

          const criticalEntries = auditEntries.filter((item) => item.severity === 'critical');
          if (criticalEntries.length) {
            const alertLines = [
              '–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ npm:',
              '',
              ...criticalEntries.map((item) => `- ${item.project}: \`${item.name}\` (—Ñ–∏–∫—Å: ${item.fix})`),
              '',
              '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø–∞–π–ø–ª–∞–π–Ω.',
            ];

            const alertPath = path.join(reportsDir, 'security-alert.md');
            fs.writeFileSync(alertPath, alertLines.join('\n'), 'utf8');

            if (process.env.GITHUB_ENV) {
              fs.appendFileSync(process.env.GITHUB_ENV, 'SECURITY_ALERT=1\n');
            }
          }
          EOF

      - name: Upload dependency report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-health
          path: reports

      - name: Create security issue for critical findings
        if: ${{ env.SECURITY_ALERT == '1' }}
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "Critical npm vulnerability detected"
          content-filepath: reports/security-alert.md
          labels: security, dependencies

