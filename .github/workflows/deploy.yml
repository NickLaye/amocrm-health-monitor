name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install backend dependencies
        run: npm ci

      - name: Install frontend dependencies
        run: cd client && npm install

      - name: Build frontend
        run: cd client && npm run build
        env:
          CI: false

      - name: Run tests
        run: npm test
        env:
          NODE_ENV: test
          API_SECRET: test_secret

      - name: Create deployment artifact
        run: |
          mkdir -p deploy
          cp -r server deploy/
          mkdir -p deploy/client
          cp -r client/build deploy/client/build
          cp package*.json deploy/
          cp -r node_modules deploy/ || echo "Skipping node_modules"
          tar -czf deploy.tar.gz deploy/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifact
          path: deploy.tar.gz
          retention-days: 7

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: deployment-artifact

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts || echo "SSH setup skipped - secrets not configured"
        continue-on-error: true

      - name: Check deployment secrets
        id: check_secrets
        run: |
          if [ -z "${{ secrets.SERVER_USER }}" ] || [ -z "${{ secrets.SERVER_HOST }}" ] || [ -z "${{ secrets.DEPLOY_PATH }}" ] || [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "secrets_configured=false" >> $GITHUB_OUTPUT
            echo "⚠️ Deployment secrets not configured. Skipping deployment step."
            echo "To enable auto-deployment, configure these secrets in GitHub:"
            echo "  - SERVER_USER"
            echo "  - SERVER_HOST"
            echo "  - DEPLOY_PATH"
            echo "  - SSH_PRIVATE_KEY"
          else
            echo "secrets_configured=true" >> $GITHUB_OUTPUT
            echo "✅ Deployment secrets configured. Proceeding with deployment."
          fi

      - name: Deploy to server
        if: steps.check_secrets.outputs.secrets_configured == 'true'
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          # Ensure deployment directory exists
          ssh ${SERVER_USER}@${SERVER_HOST} "mkdir -p '${DEPLOY_PATH}'"
          
          # Copy artifact to server using rsync
          rsync -avz deploy.tar.gz "${SERVER_USER}@${SERVER_HOST}:${DEPLOY_PATH}/"
          
          # Extract and restart services
          ssh ${SERVER_USER}@${SERVER_HOST} << 'ENDSSH'
            cd "${DEPLOY_PATH}"
            
            # Backup current version
            if [ -d "current" ]; then
              rm -rf backup
              mv current backup
            fi
            
            # Extract new version
            tar -xzf deploy.tar.gz
            mv deploy current
            cd current
            
            # Install production dependencies
            npm ci --production
            
            # Copy .env file (should exist on server)
            if [ -f "../.env" ]; then
              cp ../.env .env
            else
              echo "Warning: .env file not found"
            fi
            
            # Restart application with PM2
            pm2 restart amocrm-health-monitor || pm2 start server/index.js --name amocrm-health-monitor
            pm2 save
          ENDSSH

      - name: Health check
        if: steps.check_secrets.outputs.secrets_configured == 'true'
        continue-on-error: true
        run: |
          sleep 10
          response=$(curl -s -o /dev/null -w "%{http_code}" https://${{ secrets.SERVER_HOST }}/api/health)
          if [ $response -ne 200 ]; then
            echo "Health check failed with status code: $response"
            exit 1
          fi
          echo "Deployment successful! Health check passed."

      - name: Rollback on failure
        if: failure() && steps.check_secrets.outputs.secrets_configured == 'true'
        continue-on-error: true
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          ssh ${SERVER_USER}@${SERVER_HOST} << 'ENDSSH'
            cd "${DEPLOY_PATH}"
            # Restore previous version if exists
            if [ -d "backup" ]; then
              rm -rf current
              mv backup current
              cd current
              pm2 restart amocrm-health-monitor
              echo "Rolled back to previous version"
            fi
          ENDSSH

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: Check notification webhook
        id: check_webhook
        run: |
          if [ -z "${{ secrets.MATTERMOST_WEBHOOK_URL }}" ]; then
            echo "webhook_configured=false" >> $GITHUB_OUTPUT
            echo "⚠️ MATTERMOST_WEBHOOK_URL not configured. Skipping notification."
          else
            echo "webhook_configured=true" >> $GITHUB_OUTPUT
          fi

      - name: Send notification
        if: steps.check_webhook.outputs.webhook_configured == 'true'
        env:
          MATTERMOST_WEBHOOK: ${{ secrets.MATTERMOST_WEBHOOK_URL }}
          STATUS: ${{ needs.deploy.result }}
        run: |
          
          if [ "$STATUS" = "success" ]; then
            MESSAGE="✅ Deployment to production successful!"
            COLOR="#00ff00"
          else
            MESSAGE="❌ Deployment to production failed!"
            COLOR="#ff0000"
          fi
          
          curl -X POST ${MATTERMOST_WEBHOOK} \
            -H 'Content-Type: application/json' \
            -d "{\"text\":\"${MESSAGE}\", \"channel\":\"skypro-crm-alerts\"}"

