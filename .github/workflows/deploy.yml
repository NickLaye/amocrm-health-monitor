name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install backend dependencies
        run: npm ci

      - name: Install frontend dependencies
        run: cd client && npm install

      - name: Build frontend
        run: cd client && npm run build
        env:
          CI: false

      - name: Run tests
        run: npm test
        env:
          NODE_ENV: test
          API_SECRET: test_secret

      - name: Create deployment artifact
        run: |
          mkdir -p deploy
          cp -r server deploy/
          cp -r client/build deploy/client-build
          cp package*.json deploy/
          cp -r node_modules deploy/ || echo "Skipping node_modules"
          tar -czf deploy.tar.gz deploy/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifact
          path: deploy.tar.gz
          retention-days: 7

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'workflow_dispatch'
    environment: production

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: deployment-artifact

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts || echo "SSH setup skipped - secrets not configured"
        continue-on-error: true

      - name: Deploy to server
        if: github.event_name == 'workflow_dispatch'
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          # Check if secrets are configured
          if [ -z "$SERVER_USER" ] || [ -z "$SERVER_HOST" ] || [ -z "$DEPLOY_PATH" ]; then
            echo "⚠️ Deployment secrets not configured. Skipping deployment."
            echo "Configure SERVER_USER, SERVER_HOST, DEPLOY_PATH, and SSH_PRIVATE_KEY in GitHub secrets."
            exit 0
          fi
          # Copy artifact to server
          scp deploy.tar.gz ${SERVER_USER}@${SERVER_HOST}:${DEPLOY_PATH}/
          
          # Extract and restart services
          ssh ${SERVER_USER}@${SERVER_HOST} << 'EOF'
            cd ${DEPLOY_PATH}
            tar -xzf deploy.tar.gz
            cd deploy
            
            # Install production dependencies
            npm ci --production
            
            # Copy .env file (should exist on server)
            if [ -f "../.env" ]; then
              cp ../.env .env
            else
              echo "Warning: .env file not found"
            fi
            
            # Restart application with PM2
            pm2 restart amocrm-health-monitor || pm2 start server/index.js --name amocrm-health-monitor
            pm2 save
          EOF

      - name: Health check
        if: github.event_name == 'workflow_dispatch'
        continue-on-error: true
        run: |
          if [ -z "${{ secrets.SERVER_HOST }}" ]; then
            echo "⚠️ SERVER_HOST not configured. Skipping health check."
            exit 0
          fi
          sleep 10
          response=$(curl -s -o /dev/null -w "%{http_code}" https://${{ secrets.SERVER_HOST }}/api/health)
          if [ $response -ne 200 ]; then
            echo "Health check failed with status code: $response"
            exit 1
          fi
          echo "Deployment successful! Health check passed."

      - name: Rollback on failure
        if: failure() && github.event_name == 'workflow_dispatch'
        continue-on-error: true
        run: |
          if [ -z "${{ secrets.SERVER_USER }}" ] || [ -z "${{ secrets.SERVER_HOST }}" ]; then
            echo "⚠️ Secrets not configured. Skipping rollback."
            exit 0
          fi
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            cd ${{ secrets.DEPLOY_PATH }}
            # Restore previous version if exists
            if [ -d "deploy.backup" ]; then
              rm -rf deploy
              mv deploy.backup deploy
              cd deploy
              pm2 restart amocrm-health-monitor
              echo "Rolled back to previous version"
            fi
          EOF

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: deploy
    if: always() && github.event_name == 'workflow_dispatch'

    steps:
      - name: Send notification
        continue-on-error: true
        env:
          MATTERMOST_WEBHOOK: ${{ secrets.MATTERMOST_WEBHOOK_URL }}
          STATUS: ${{ needs.deploy.result }}
        run: |
          if [ -z "$MATTERMOST_WEBHOOK" ]; then
            echo "⚠️ MATTERMOST_WEBHOOK_URL not configured. Skipping notification."
            exit 0
          fi
          
          if [ "$STATUS" = "success" ]; then
            MESSAGE="✅ Deployment to production successful!"
            COLOR="#00ff00"
          else
            MESSAGE="❌ Deployment to production failed!"
            COLOR="#ff0000"
          fi
          
          curl -X POST ${MATTERMOST_WEBHOOK} \
            -H 'Content-Type: application/json' \
            -d "{\"text\":\"${MESSAGE}\", \"channel\":\"skypro-crm-alerts\"}"

