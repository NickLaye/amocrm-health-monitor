# amoCRM Health Monitor Dashboard

Real-time –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ amoCRM —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ –≤ Mattermost –∏ –∫—Ä–∞—Å–∏–≤—ã–º –¥–∞—à–±–æ—Ä–¥–æ–º.

> üìù **–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:** [CHANGELOG.md](./CHANGELOG.md)  
> üèóÔ∏è **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** [ARCHITECTURE.md](./ARCHITECTURE.md)  
> üìÇ **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:** [PROJECT_STRUCTURE.md](./PROJECT_STRUCTURE.md)

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ 5 —Ç–∏–ø–æ–≤ –ø—Ä–æ–≤–µ—Ä–æ–∫:
  - **GET API** - –ø—Ä–æ–≤–µ—Ä–∫–∞ API –Ω–∞ —á—Ç–µ–Ω–∏–µ
  - **POST API** - –ø—Ä–æ–≤–µ—Ä–∫–∞ API –Ω–∞ –∑–∞–ø–∏—Å—å
  - **WEB** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
  - **HOOK** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã webhooks
  - **DP** - –ø—Ä–æ–≤–µ—Ä–∫–∞ Digital Pipeline
- üìä Real-time –¥–∞—à–±–æ—Ä–¥ —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞
- üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ uptime –∏ —Å—Ä–µ–¥–Ω–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞
- üîî –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Mattermost –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏
- üìú –ò—Å—Ç–æ—Ä–∏—è –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤
- üíæ SQLite –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
- üîÑ Server-Sent Events (SSE) –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Node.js 16+ 
- npm –∏–ª–∏ yarn
- –î–æ—Å—Ç—É–ø –∫ amoCRM API (access token)
- Mattermost webhook URL (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è backend
npm install

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è frontend
cd client
npm install
cd ..
```

### 2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:

```bash
cp .env.example .env
```

–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

```env
# amoCRM Configuration
AMOCRM_DOMAIN=your-domain.amocrm.ru
AMOCRM_ACCESS_TOKEN=your_access_token_here

# Mattermost Webhook
MATTERMOST_WEBHOOK_URL=https://your-mattermost.com/hooks/your_webhook_id

# Monitoring Settings
CHECK_INTERVAL=30000          # –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–æ–∫ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö (30 —Å–µ–∫)
TIMEOUT_THRESHOLD=10000       # –¢–∞–π–º–∞—É—Ç –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–∞–¥–µ–Ω–∏—è (10 —Å–µ–∫)

# Server Configuration
PORT=3001
NODE_ENV=development
```

### 3. –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

```bash
# –¢–µ—Ä–º–∏–Ω–∞–ª 1 - –∑–∞–ø—É—Å–∫ backend
npm run dev

# –¢–µ—Ä–º–∏–Ω–∞–ª 2 - –∑–∞–ø—É—Å–∫ frontend
cd client
npm start
```

Frontend –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ `http://localhost:3000`  
Backend API –Ω–∞ `http://localhost:3001`

### 4. –°–±–æ—Ä–∫–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

```bash
# –°–æ–±—Ä–∞—Ç—å frontend
cd client
npm run build
cd ..

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ production —Ä–µ–∂–∏–º–µ
NODE_ENV=production npm start
```

## –î–µ–ø–ª–æ–π –Ω–∞ –æ–±–ª–∞—á–Ω—ã–π —Å–µ—Ä–≤–µ—Ä

### –í–∞—Ä–∏–∞–Ω—Ç 1: PM2 (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å PM2 –≥–ª–æ–±–∞–ª—å–Ω–æ
npm install -g pm2

# –°–æ–±—Ä–∞—Ç—å frontend
cd client && npm run build && cd ..

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å PM2
pm2 start ecosystem.config.js

# –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫
pm2 startup
pm2 save
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: Nginx + PM2

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Nginx –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:

```bash
sudo apt update
sudo apt install nginx
```

2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Nginx:

```bash
sudo cp nginx.conf /etc/nginx/sites-available/amocrm-health
sudo ln -s /etc/nginx/sites-available/amocrm-health /etc/nginx/sites-enabled/
```

3. Nginx —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –¥–æ–º–µ–Ω–∞ `amohealth.duckdns.org`
   - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
   - SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –±—É–¥—É—Ç –ø–æ–ª—É—á–µ–Ω—ã —á–µ—Ä–µ–∑ Let's Encrypt

4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ Nginx:

```bash
sudo nginx -t
sudo systemctl reload nginx
```

5. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å PM2 (—Å–º. –í–∞—Ä–∏–∞–Ω—Ç 1)

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSL —Å Let's Encrypt

```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```

## API Endpoints

### GET /api/status
–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "data": {
    "GET": {
      "status": "up",
      "responseTime": 450,
      "lastCheck": 1699876543210,
      "errorMessage": null
    },
    ...
  }
}
```

### GET /api/history?checkType=GET&hours=24
–ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–æ–≤–µ—Ä–æ–∫

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `checkType` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) - —Ç–∏–ø –ø—Ä–æ–≤–µ—Ä–∫–∏ (GET, POST, WEB, HOOK, DP)
- `hours` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) - –ø–µ—Ä–∏–æ–¥ –≤ —á–∞—Å–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 24)

### GET /api/incidents?limit=50
–ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `limit` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 50)

### GET /api/stats?hours=24
–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `hours` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) - –ø–µ—Ä–∏–æ–¥ –≤ —á–∞—Å–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 24)

### GET /api/stream
Server-Sent Events –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
amocrm-health-monitor/
‚îú‚îÄ‚îÄ server/
‚îÇ   ‚îú‚îÄ‚îÄ index.js          # –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª —Å–µ—Ä–≤–µ—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ api.js            # API endpoints
‚îÇ   ‚îú‚îÄ‚îÄ monitor.js        # –°–µ—Ä–≤–∏—Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
‚îÇ   ‚îú‚îÄ‚îÄ database.js       # –†–∞–±–æ—Ç–∞ —Å SQLite
‚îÇ   ‚îî‚îÄ‚îÄ notifications.js  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Mattermost
‚îú‚îÄ‚îÄ client/
‚îÇ   ‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ       ‚îú‚îÄ‚îÄ components/   # React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ       ‚îú‚îÄ‚îÄ services/     # API –∫–ª–∏–µ–Ω—Ç
‚îÇ       ‚îú‚îÄ‚îÄ App.js
‚îÇ       ‚îî‚îÄ‚îÄ index.js
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ ecosystem.config.js   # PM2 –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ nginx.conf           # Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îî‚îÄ‚îÄ README.md
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ PM2

```bash
# –í—Å–µ –ª–æ–≥–∏
pm2 logs

# –õ–æ–≥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
pm2 logs amocrm-health-monitor

# –¢–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏
pm2 logs --err
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤

```bash
# –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
pm2 status

# –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
pm2 show amocrm-health-monitor

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
pm2 monit
```

## Troubleshooting

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—à–∏–±–∫–∞ "database is locked":

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
pm2 stop amocrm-health-monitor

# –£–¥–∞–ª–∏—Ç—å lock —Ñ–∞–π–ª
rm health_checks.db-journal

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–Ω–æ–≤–∞
pm2 start amocrm-health-monitor
```

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å webhook URL –≤ `.env`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `pm2 logs amocrm-health-monitor`
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Mattermost webhook –∞–∫—Ç–∏–≤–µ–Ω

### –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞

–ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –∏—Å–ø—ã—Ç—ã–≤–∞–µ—Ç –≤—ã—Å–æ–∫—É—é –Ω–∞–≥—Ä—É–∑–∫—É:

1. –£–≤–µ–ª–∏—á—å—Ç–µ `CHECK_INTERVAL` –≤ `.env` (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ 60000 –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É)
2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ä–æ—Ç–∞—Ü–∏—é –ª–æ–≥–æ–≤ –≤ `ecosystem.config.js`
3. –í–∫–ª—é—á–∏—Ç–µ cleanup —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ä–∞–∑ –≤ –¥–µ–Ω—å)

## –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ

```bash
# –ü–æ–ª—É—á–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
git pull

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
npm install
cd client && npm install && cd ..

# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å frontend
cd client && npm run build && cd ..

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å PM2
pm2 reload ecosystem.config.js
```

## –õ–∏—Ü–µ–Ω–∑–∏—è

MIT

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º —Å–æ–∑–¥–∞–π—Ç–µ issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞.

